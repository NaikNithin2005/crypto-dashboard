<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NINAR – Exchange</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Unicons -->
    <link rel="stylesheet"
          href="https://unicons.iconscout.com/release/v4.0.8/css/line.css">

    <!-- Global styles with nav + sidebar -->
    <link rel="stylesheet" href="/main-style.css">

    <style>
        :root {
            --bg-body: #f5f5ff;
            --sidebar-bg: #ffffff;
            --card-bg: #ffffff;
            --text-main: #111827;
            --text-muted: #9ca3af;
            --accent: #5b21ff;
            --accent-soft: rgba(91, 33, 255, 0.08);
            --danger: #ef4444;
            --success: #22c55e;
            --border-subtle: #e5e7eb;
            --radius-lg: 1.4rem;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
            sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
        }

        /* Layout shell – only main content now (sidebar comes from main-style.css) */
        .app {
            display: grid;
            grid-template-columns: minmax(0, 1fr);
            min-height: 100vh;
        }

        .main {
            padding: 1.4rem 2rem 2rem;
            width: 100%;
        }

        @media (max-width: 960px) {
            .app {
                grid-template-columns: 1fr;
            }

            .main {
                padding: 1rem 1rem 1.6rem;
            }
        }

        /* Top bar */

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .topbar-left {
            display: flex;
            flex-direction: column;
        }

        .topbar-left h1 {
            margin: 0;
            font-size: 1.4rem;
        }

        .topbar-left span {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .topbar-search {
            flex: 1;
            display: flex;
            justify-content: flex-end;
        }

        .search-input {
            max-width: 340px;
            width: 100%;
            background: #ffffff;
            border-radius: 999px;
            display: flex;
            align-items: center;
            padding: 0.4rem 0.8rem;
            border: 1px solid var(--border-subtle);
            gap: 0.4rem;
        }

        .search-input i {
            color: var(--text-muted);
        }

        .search-input input {
            border: none;
            outline: none;
            background: transparent;
            flex: 1;
            font-size: 0.9rem;
        }

        /* Layout for exchange content */

        .exchange-layout {
            display: grid;
            grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.1fr);
            gap: 1.5rem;
        }

        @media (max-width: 1100px) {
            .exchange-layout {
                grid-template-columns: 1fr;
            }
        }

        .left-column {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }

        .right-column {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-subtle);
            padding: 1.2rem 1.3rem;
            box-shadow: 0 24px 60px rgba(15, 23, 42, 0.12);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .card-header h2 {
            margin: 0;
            font-size: 1rem;
        }

        .card-header span.sub {
            font-size: 0.78rem;
            color: var(--text-muted);
        }

        /* Tabs (All / Favourites / Watchlist) */

        .tabs {
            display: inline-flex;
            background: #f9fafb;
            border-radius: 999px;
            padding: 0.17rem;
            border: 1px solid var(--border-subtle);
        }

        .tab {
            border: none;
            background: transparent;
            padding: 0.35rem 0.9rem;
            border-radius: 999px;
            font-size: 0.8rem;
            color: var(--text-muted);
            cursor: pointer;
        }

        .tab.active {
            background: var(--accent);
            color: #ffffff;
        }

        /* Markets table */

        .markets-header-row {
            display: grid;
            grid-template-columns: 2.2fr 1.1fr 1.1fr 1.3fr 1.2fr;
            font-size: 0.78rem;
            color: var(--text-muted);
            padding: 0 0.2rem 0.4rem;
            border-bottom: 1px solid #f3f4f6;
        }

        .markets-list {
            margin-top: 0.4rem;
            max-height: 270px;
            overflow-y: auto;
        }

        .markets-list::-webkit-scrollbar,
        .orderbook-list::-webkit-scrollbar,
        .trades-list::-webkit-scrollbar,
        .orders-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .markets-list::-webkit-scrollbar-thumb,
        .orderbook-list::-webkit-scrollbar-thumb,
        .trades-list::-webkit-scrollbar-thumb,
        .orders-scroll::-webkit-scrollbar-thumb {
            background: #e5e7eb;
            border-radius: 999px;
        }

        .market-row {
            display: grid;
            grid-template-columns: 2.2fr 1.1fr 1.1fr 1.3fr 1.2fr;
            align-items: center;
            gap: 0.4rem;
            padding: 0.6rem 0.2rem;
            font-size: 0.82rem;
            border-bottom: 1px solid #f3f4f6;
        }

        .market-row:last-child {
            border-bottom: none;
        }

        .market-main {
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .coin-avatar {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            background: linear-gradient(135deg, #f97316, #facc15);
        }

        .coin-avatar.eth {
            background: linear-gradient(135deg, #6366f1, #0ea5e9);
        }

        .coin-avatar.bnb {
            background: linear-gradient(135deg, #facc15, #f59e0b);
        }

        .coin-avatar.sol {
            background: linear-gradient(135deg, #22c55e, #06b6d4);
        }

        .coin-avatar.usdt {
            background: linear-gradient(135deg, #16a34a, #22c55e);
        }

        .coin-label {
            display: flex;
            flex-direction: column;
        }

        .coin-label span:first-child {
            font-weight: 600;
        }

        .coin-label span:last-child {
            font-size: 0.72rem;
            color: var(--text-muted);
        }

        .change-positive {
            color: var(--success);
        }

        .change-negative {
            color: var(--danger);
        }

        .fav-watch {
            display: flex;
            gap: 0.35rem;
        }

        .icon-btn {
            width: 26px;
            height: 26px;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            background: #ffffff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            color: var(--text-muted);
        }

        .icon-btn.active {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-soft);
        }

        .buy-sell-actions {
            display: flex;
            gap: 0.4rem;
        }

        .pill {
            border-radius: 999px;
            padding: 0.25rem 0.6rem;
            font-size: 0.75rem;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        .pill.buy {
            background: rgba(34, 197, 94, 0.12);
            color: var(--success);
        }

        .pill.sell {
            background: rgba(239, 68, 68, 0.12);
            color: var(--danger);
        }

        /* Order book + trades */

        .orderbook-grid {
            display: grid;
            grid-template-columns: 1.1fr 1.1fr;
            gap: 0.8rem;
        }

        .orderbook-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.78rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .orderbook-list {
            max-height: 180px;
            overflow-y: auto;
            font-size: 0.8rem;
        }

        .orderbook-row {
            display: flex;
            justify-content: space-between;
            padding: 0.18rem 0;
        }

        .orderbook-row span:first-child {
            min-width: 57px;
        }

        .orderbook-row span.price.ask {
            color: var(--danger);
        }

        .orderbook-row span.price.bid {
            color: var(--success);
        }

        .orderbook-row span.size {
            color: var(--text-muted);
        }

        .mid-price {
            text-align: center;
            font-size: 0.8rem;
            margin: 0.4rem 0;
        }

        .mid-price span {
            padding: 0.18rem 0.6rem;
            border-radius: 999px;
            background: #f3f4f6;
        }

        .trades-list {
            max-height: 130px;
            overflow-y: auto;
            font-size: 0.8rem;
            margin-top: 0.4rem;
        }

        .trade-row {
            display: grid;
            grid-template-columns: 0.9fr 0.9fr 1.1fr;
            padding: 0.18rem 0;
        }

        .trade-row span.side-buy {
            color: var(--success);
        }

        .trade-row span.side-sell {
            color: var(--danger);
        }

        .muted {
            color: var(--text-muted);
        }

        /* Trade panel */

        .side-card-section {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }

        .toggle-row {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .pill-toggle {
            display: inline-flex;
            background: #f9fafb;
            border-radius: 999px;
            padding: 0.17rem;
            border: 1px solid var(--border-subtle);
        }

        .pill-toggle button {
            border: none;
            background: transparent;
            padding: 0.32rem 1rem;
            border-radius: 999px;
            font-size: 0.8rem;
            color: var(--text-muted);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .pill-toggle button.active {
            color: #ffffff;
        }

        .pill-toggle button.active.buy {
            background: var(--success);
        }

        .pill-toggle button.active.sell {
            background: var(--danger);
        }

        .pill-toggle button.active.type {
            background: var(--accent);
        }

        .pill-toggle i {
            font-size: 1rem;
        }

        .pair-highlight {
            margin-top: 0.7rem;
            display: flex;
            flex-direction: column;
            gap: 0.1rem;
        }

        .pair-highlight span.label {
            font-size: 0.78rem;
            color: var(--text-muted);
        }

        .pair-highlight span.price {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .pair-highlight span.change-chip {
            font-size: 0.78rem;
            padding: 0.12rem 0.5rem;
            border-radius: 999px;
            display: inline-block;
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }

        .pair-highlight span.change-chip.red {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        form.exchange-form {
            margin-top: 1rem;
        }

        .form-group {
            margin-bottom: 0.8rem;
            font-size: 0.82rem;
        }

        .form-group label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.2rem;
            color: var(--text-muted);
        }

        .form-group label span.title {
            color: #111827;
            font-weight: 500;
        }

        .form-group label span.info {
            font-size: 0.75rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            border-radius: 0.8rem;
            border: 1px solid #e5e7eb;
            padding: 0.55rem 0.7rem;
            font-size: 0.86rem;
            outline: none;
            background: #f9fafb;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(91, 33, 255, 0.15);
            background: #ffffff;
        }

        .form-group input[readonly] {
            background: #f3f4f6;
        }

        .summary-box {
            margin-top: 0.4rem;
            padding: 0.55rem 0.7rem;
            border-radius: 0.9rem;
            background: #f9fafb;
            border: 1px dashed #e5e7eb;
            font-size: 0.8rem;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.15rem;
        }

        .summary-row span:first-child {
            color: var(--text-muted);
        }

        .summary-row span:last-child {
            font-weight: 500;
        }

        .summary-row:last-child {
            margin-bottom: 0;
        }

        .primary-btn {
            margin-top: 0.8rem;
            width: 100%;
            border-radius: 999px;
            border: none;
            padding: 0.75rem;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            cursor: pointer;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: #ffffff;
            font-weight: 600;
        }

        .primary-btn.sell {
            background: linear-gradient(135deg, #fb7185, #ef4444);
        }

        .primary-btn:active {
            transform: translateY(1px);
        }

        .status-msg {
            margin-top: 0.45rem;
            font-size: 0.78rem;
        }

        .status-success {
            color: var(--success);
        }

        .status-error {
            color: var(--danger);
        }

        /* Wallet + orders */

        .wallet-list {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .wallet-row {
            display: flex;
            justify-content: space-between;
            padding: 0.2rem 0;
        }

        .wallet-row span:first-child {
            font-weight: 500;
            color: #111827;
        }

        .orders-tabs {
            margin-top: 0.8rem;
        }

        .orders-tabs-buttons {
            display: inline-flex;
            border-radius: 999px;
            background: #f9fafb;
            border: 1px solid var(--border-subtle);
            padding: 0.17rem;
        }

        .orders-tabs-buttons button {
            border: none;
            background: transparent;
            font-size: 0.78rem;
            padding: 0.25rem 0.8rem;
            border-radius: 999px;
            color: var(--text-muted);
            cursor: pointer;
        }

        .orders-tabs-buttons button.active {
            background: var(--accent);
            color: #ffffff;
        }

        .orders-scroll {
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.78rem;
            margin-top: 0.4rem;
        }

        .orders-header {
            display: grid;
            grid-template-columns: 0.8fr 0.8fr 0.7fr 0.9fr 1fr;
            color: var(--text-muted);
            margin-bottom: 0.15rem;
        }

        .orders-row {
            display: grid;
            grid-template-columns: 0.8fr 0.8fr 0.7fr 0.9fr 1fr;
            margin-bottom: 0.1rem;
        }

        .tag {
            border-radius: 999px;
            padding: 0.05rem 0.45rem;
            font-size: 0.7rem;
            display: inline-block;
        }

        .tag.buy {
            background: rgba(34, 197, 94, 0.14);
            color: var(--success);
        }

        .tag.sell {
            background: rgba(239, 68, 68, 0.14);
            color: var(--danger);
        }

        .fee-text {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.1rem;
        }
    </style>
</head>
<body>

<!-- ++++ NAV BAR ++++ -->
<nav>
    <div class="container nav_container">
        <a href="../../main-index.html" class="nav_logo">
            <img src="../../assets/images/ninar logo.png" alt="logo">
        </a>
        <div class="nav_search">
            <i class="uil uil-search"></i>
            <input type="search" placeholder="search">
        </div>
        <div class="nav_profile-wrapper">
            <button class="nav_theme-btn">
                <i class="uil uil-moon"></i>
            </button>
            <div class="nav_profile">
                <div class="nav_profile-photo">
                    <img src="https://tse1.explicit.bing.net/th/id/OIP.hGSCbXlcOjL_9mmzerqAbQHaHa?rs=1&pid=ImgDetMain&o=7&rm=3"
                         alt="profile photo">
                </div>
                <h5>Nithin</h5>
                <i class="uil uil-angle-down"></i>
            </div>
            <button class="nav_menu-btn">
                <i class="uil uil-bars"></i>
            </button>
        </div>
    </div>
</nav>

<!-- +++++ SIDEBAR ++++ -->
<menu class="sidebar">
    <a href="../../main-index.html">
        <i class="uil uil-create-dashboard"></i>
        <h5>Dashboard</h5>
    </a>

    <a href="exchange.html" class="active">
        <i class="uil uil-exchange"></i>
        <h5>Exchange</h5>
    </a>

    <a href="../wallet/wallet.html">
        <i class="uil uil-wallet"></i>
        <h5>Wallet</h5>
    </a>

    <a href="../transactions/transaction.html">
        <i class="uil uil-transaction"></i>
        <h5>Transacations</h5>
    </a>

    <a href="../analytics/analytics.html">
        <i class="uil uil-chart-line"></i>
        <h5>Analytics</h5>
    </a>

    <a href="../message/message.html">
        <i class="uil uil-comment-alt-message"></i>
        <h5>Message</h5>
    </a>

    <a href="../help/help.html">
        <i class="uil uil-question-circle"></i>
        <h5>Help Center</h5>
    </a>

    <a href="../settings/settings.html">
        <i class="uil uil-setting"></i>
        <h5>Settings</h5>
    </a>

    <button class="sidebar_close-btn">
        <i class="uil uil-times"></i>
    </button>
</menu>

<div class="app">
    <!-- Main -->
    <main class="main">
        <header class="topbar">
            <div class="topbar-left">
                <h1>Exchange</h1>
                <span>Trade crypto, manage favourites & watchlist – demo only (no backend)</span>
            </div>
            <div class="topbar-search">
                <div class="search-input">
                    <i class="uil uil-search"></i>
                    <input type="text" id="searchInput" placeholder="Search coin / symbol">
                </div>
            </div>
        </header>

        <section class="exchange-layout">
            <div class="left-column">
                <!-- Markets -->
                <section class="card">
                    <div class="card-header">
                        <div>
                            <h2>Markets</h2>
                            <span class="sub">Live-style prices with favourites & watchlist</span>
                        </div>
                        <div class="tabs">
                            <button class="tab active" data-tab="all">All</button>
                            <button class="tab" data-tab="favourites">Favourites</button>
                            <button class="tab" data-tab="watchlist">Watchlist</button>
                        </div>
                    </div>

                    <div class="markets-header-row">
                        <span>Pair</span>
                        <span>Price</span>
                        <span>24h Change</span>
                        <span>24h Volume</span>
                        <span>Actions</span>
                    </div>

                    <div class="markets-list" id="marketsList"></div>
                </section>

                <!-- Order book + trades -->
                <section class="card">
                    <div class="card-header">
                        <div>
                            <h2>Order Book & Trades</h2>
                            <span class="sub" id="obPairTitle">BTC / USDT</span>
                        </div>
                    </div>

                    <div class="orderbook-grid">
                        <div>
                            <div class="orderbook-header">
                                <span>Asks</span>
                                <span>Size</span>
                            </div>
                            <div class="orderbook-list" id="asksList"></div>
                        </div>
                        <div>
                            <div class="orderbook-header">
                                <span>Bids</span>
                                <span>Size</span>
                            </div>
                            <div class="orderbook-list" id="bidsList"></div>
                        </div>
                    </div>

                    <div class="mid-price">
                        <span id="midPriceLabel">$0.00</span>
                    </div>

                    <div>
                        <div class="orderbook-header">
                            <span>Recent Trades</span>
                            <span>Side • Price • Amount</span>
                        </div>
                        <div class="trades-list" id="tradesList"></div>
                    </div>
                </section>
            </div>

            <div class="right-column side-card-section">

                <!-- Trade panel -->
                <section class="card">
                    <div class="card-header">
                        <div>
                            <h2>Trade</h2>
                            <span class="sub" id="pairTitle">BTC / USDT</span>
                        </div>
                        <div class="toggle-row">
                            <div class="pill-toggle" id="sideToggle">
                                <button type="button" class="active buy" data-side="BUY">
                                    <i class="uil uil-arrow-up-right"></i> Buy
                                </button>
                                <button type="button" data-side="SELL">
                                    <i class="uil uil-arrow-down-left"></i> Sell
                                </button>
                            </div>
                            <div class="pill-toggle" id="typeToggle">
                                <button type="button" class="active type" data-type="MARKET">Market</button>
                                <button type="button" data-type="LIMIT">Limit</button>
                            </div>
                        </div>
                    </div>

                    <div class="pair-highlight">
                        <span class="label">Last Price</span>
                        <span class="price" id="pairPrice">$0.00</span>
                        <span class="change-chip" id="pairChange">+0.00%</span>
                    </div>

                    <form class="exchange-form" id="orderForm">
                        <input type="hidden" id="orderSide" value="BUY">
                        <input type="hidden" id="orderType" value="MARKET">

                        <div class="form-group">
                            <label>
                                <span class="title">Coin</span>
                                <span class="info">
                                    Balance:
                                    <strong id="availableBalance">0.00000000 BTC</strong>
                                </span>
                            </label>
                            <select id="symbolSelect"></select>
                        </div>

                        <div class="form-group">
                            <label>
                                <span class="title">Amount</span>
                                <span class="info" id="amountHint">Amount you want to buy</span>
                            </label>
                            <input type="number" id="amountInput" min="0" step="0.00000001"
                                   placeholder="0.0000">
                        </div>

                        <div class="form-group">
                            <label>
                                <span class="title">Price (USDT)</span>
                                <span class="info" id="priceInfo">Market price</span>
                            </label>
                            <input type="number" id="priceInput" min="0" step="0.01"
                                   placeholder="0.00" readonly>
                        </div>

                        <div class="form-group">
                            <label>
                                <span class="title">Total (USDT)</span>
                                <span class="info">Amount × Price</span>
                            </label>
                            <input type="number" id="totalInput" readonly placeholder="0.00">
                            <div class="fee-text" id="feeText">Fee (0.1%): 0.0000 USDT</div>
                        </div>

                        <div class="summary-box">
                            <div class="summary-row">
                                <span>Side</span>
                                <span id="summarySide">Buy</span>
                            </div>
                            <div class="summary-row">
                                <span>Type</span>
                                <span id="summaryType">Market</span>
                            </div>
                            <div class="summary-row">
                                <span>Pair</span>
                                <span id="summaryPair">BTC / USDT</span>
                            </div>
                            <div class="summary-row">
                                <span>Estimated</span>
                                <span id="summaryTotal">0.00 USDT</span>
                            </div>
                        </div>

                        <button type="submit" class="primary-btn" id="submitBtn">
                            <i class="uil uil-shopping-cart-alt"></i>
                            <span id="submitLabel">Place Buy Market Order</span>
                        </button>

                        <div id="statusMsg" class="status-msg"></div>
                    </form>
                </section>

                <!-- Wallet & Orders -->
                <section class="card">
                    <div class="card-header">
                        <div>
                            <h2>Wallet & Orders</h2>
                            <span class="sub">Local demo balances & order simulator</span>
                        </div>
                    </div>

                    <div class="wallet-list" id="walletList"></div>

                    <div class="orders-tabs">
                        <div class="orders-tabs-buttons">
                            <button type="button" class="active" data-orders-tab="open">Open Orders</button>
                            <button type="button" data-orders-tab="history">Order History</button>
                        </div>
                        <div class="orders-scroll" id="ordersContainer">
                            <!-- Filled by JS -->
                        </div>
                    </div>
                </section>
            </div>
        </section>
    </main>
</div>

<script>
    // ===== DEMO DATA (FRONTEND ONLY, NO BACKEND) =====

    const coins = [
        {
            symbol: "BTC",
            name: "Bitcoin",
            price: 82719,
            change: 1.72,
            volume: 120000000,
            orderBook: {bids: [], asks: []},
            trades: []
        },
        {
            symbol: "ETH",
            name: "Ethereum",
            price: 3719,
            change: -0.84,
            volume: 78000000,
            orderBook: {bids: [], asks: []},
            trades: []
        },
        {
            symbol: "BNB",
            name: "Binance Coin",
            price: 628,
            change: 0.32,
            volume: 32000000,
            orderBook: {bids: [], asks: []},
            trades: []
        },
        {
            symbol: "SOL",
            name: "Solana",
            price: 142.5,
            change: 3.12,
            volume: 56000000,
            orderBook: {bids: [], asks: []},
            trades: []
        },
        {
            symbol: "USDT",
            name: "Tether",
            price: 1.0,
            change: 0.02,
            volume: 890000000,
            orderBook: {bids: [], asks: []},
            trades: []
        }
    ];

    const balances = {
        BTC: 0.05234567,
        ETH: 1.21456789,
        BNB: 2.437621,
        SOL: 10.432156,
        USDT: 2500.12
    };

    const favourites = new Set();
    const watchlist = new Set();
    const openOrders = [];
    const orderHistory = [];
    let nextOrderId = 1;

    // ===== STATE =====

    let currentSymbol = "BTC";
    let currentSide = "BUY";
    let currentType = "MARKET"; // MARKET | LIMIT
    let currentTab = "all";
    let currentOrdersTab = "open";

    const FEE_RATE = 0.001; // 0.1%

    // ===== DOM ELEMENTS =====

    const marketsListEl = document.getElementById("marketsList");
    const searchInput = document.getElementById("searchInput");
    const tabs = document.querySelectorAll(".tab");

    const obPairTitle = document.getElementById("obPairTitle");
    const asksListEl = document.getElementById("asksList");
    const bidsListEl = document.getElementById("bidsList");
    const tradesListEl = document.getElementById("tradesList");
    const midPriceLabel = document.getElementById("midPriceLabel");

    const sideToggle = document.getElementById("sideToggle");
    const typeToggle = document.getElementById("typeToggle");
    const orderSideInput = document.getElementById("orderSide");
    const orderTypeInput = document.getElementById("orderType");
    const pairTitle = document.getElementById("pairTitle");
    const pairPriceEl = document.getElementById("pairPrice");
    const pairChangeEl = document.getElementById("pairChange");

    const symbolSelect = document.getElementById("symbolSelect");
    const availableBalanceEl = document.getElementById("availableBalance");
    const amountHint = document.getElementById("amountHint");
    const amountInput = document.getElementById("amountInput");
    const priceInput = document.getElementById("priceInput");
    const priceInfo = document.getElementById("priceInfo");
    const totalInput = document.getElementById("totalInput");
    const feeText = document.getElementById("feeText");

    const summarySide = document.getElementById("summarySide");
    const summaryType = document.getElementById("summaryType");
    const summaryPair = document.getElementById("summaryPair");
    const summaryTotal = document.getElementById("summaryTotal");
    const submitBtn = document.getElementById("submitBtn");
    const submitLabel = document.getElementById("submitLabel");
    const statusMsg = document.getElementById("statusMsg");
    const orderForm = document.getElementById("orderForm");

    const walletList = document.getElementById("walletList");
    const ordersContainer = document.getElementById("ordersContainer");
    const ordersTabsButtons = document.querySelectorAll("[data-orders-tab]");

    // ===== HELPERS =====

    function formatNumber(val, decimals = 2) {
        return Number(val).toLocaleString(undefined, {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        });
    }

    function formatCompact(val) {
        return Intl.NumberFormat("en", {
            notation: "compact",
            maximumFractionDigits: 2
        }).format(val);
    }

    function getCoin(symbol) {
        return coins.find(c => c.symbol === symbol);
    }

    // ===== RENDER FUNCTIONS =====

    function renderMarkets() {
        const q = (searchInput.value || "").trim().toLowerCase();
        marketsListEl.innerHTML = "";

        let filtered = coins.slice();

        if (currentTab === "favourites") {
            filtered = filtered.filter(c => favourites.has(c.symbol));
        } else if (currentTab === "watchlist") {
            filtered = filtered.filter(c => watchlist.has(c.symbol));
        }

        if (q) {
            filtered = filtered.filter(c =>
                c.symbol.toLowerCase().includes(q) ||
                c.name.toLowerCase().includes(q)
            );
        }

        if (filtered.length === 0) {
            marketsListEl.innerHTML =
                '<div class="muted" style="padding:0.7rem 0.2rem;font-size:0.8rem;">No coins match this filter.</div>';
            return;
        }

        filtered.forEach(c => {
            const row = document.createElement("div");
            row.className = "market-row";

            const avatarClass =
                c.symbol === "ETH" ? "eth" :
                    c.symbol === "BNB" ? "bnb" :
                        c.symbol === "SOL" ? "sol" :
                            c.symbol === "USDT" ? "usdt" : "";

            const changeClass = c.change >= 0 ? "change-positive" : "change-negative";
            const changeText = (c.change >= 0 ? "+" : "") + c.change.toFixed(2) + "%";

            row.innerHTML = `
                <div class="market-main">
                    <div class="coin-avatar ${avatarClass}"></div>
                    <div class="coin-label">
                        <span>${c.symbol} / USDT</span>
                        <span>${c.name}</span>
                    </div>
                </div>
                <div>$${formatNumber(c.price, 2)}</div>
                <div class="${changeClass}">${changeText}</div>
                <div>${formatCompact(c.volume)} USDT</div>
                <div>
                    <div class="buy-sell-actions" style="margin-bottom:0.3rem;">
                        <button class="pill buy" data-action="buy" data-symbol="${c.symbol}">Buy</button>
                        <button class="pill sell" data-action="sell" data-symbol="${c.symbol}">Sell</button>
                    </div>
                    <div class="fav-watch">
                        <button class="icon-btn ${favourites.has(c.symbol) ? "active" : ""}"
                                data-icon="fav" data-symbol="${c.symbol}">
                            <i class="uil uil-heart"></i>
                        </button>
                        <button class="icon-btn ${watchlist.has(c.symbol) ? "active" : ""}"
                                data-icon="watch" data-symbol="${c.symbol}">
                            <i class="uil uil-star"></i>
                        </button>
                    </div>
                </div>
            `;
            marketsListEl.appendChild(row);
        });
    }

    function renderOrderBook() {
        const coin = getCoin(currentSymbol);
        if (!coin) return;

        obPairTitle.textContent = `${coin.symbol} / USDT`;

        asksListEl.innerHTML = "";
        bidsListEl.innerHTML = "";

        coin.orderBook.asks.forEach(a => {
            const row = document.createElement("div");
            row.className = "orderbook-row";
            row.innerHTML = `
                <span class="price ask">$${formatNumber(a.price, 2)}</span>
                <span class="size">${formatNumber(a.size, 4)}</span>
            `;
            asksListEl.appendChild(row);
        });

        coin.orderBook.bids.forEach(b => {
            const row = document.createElement("div");
            row.className = "orderbook-row";
            row.innerHTML = `
                <span class="price bid">$${formatNumber(b.price, 2)}</span>
                <span class="size">${formatNumber(b.size, 4)}</span>
            `;
            bidsListEl.appendChild(row);
        });

        const mid = coin.price;
        midPriceLabel.textContent = `Mid: $${formatNumber(mid, 2)}`;
    }

    function renderTrades() {
        const coin = getCoin(currentSymbol);
        if (!coin) return;
        tradesListEl.innerHTML = "";

        if (coin.trades.length === 0) {
            tradesListEl.innerHTML = '<div class="muted">Waiting for first trades…</div>';
            return;
        }

        coin.trades.slice().reverse().forEach(t => {
            const row = document.createElement("div");
            row.className = "trade-row";
            const sideClass = t.side === "BUY" ? "side-buy" : "side-sell";
            row.innerHTML = `
                <span class="${sideClass}">${t.side}</span>
                <span>$${formatNumber(t.price, 2)}</span>
                <span class="muted">${formatNumber(t.amount, 5)}</span>
            `;
            tradesListEl.appendChild(row);
        });
    }

    function renderWallet() {
        walletList.innerHTML = "";
        Object.keys(balances).forEach(symbol => {
            const row = document.createElement("div");
            row.className = "wallet-row";
            row.innerHTML = `
                <span>${symbol}</span>
                <span>${formatNumber(balances[symbol], 6)}</span>
            `;
            walletList.appendChild(row);
        });
    }

    function renderOrders() {
        ordersContainer.innerHTML = "";

        const source = currentOrdersTab === "open" ? openOrders : orderHistory;

        if (source.length === 0) {
            ordersContainer.innerHTML =
                `<div class="muted" style="font-size:0.78rem;">No ${currentOrdersTab === "open" ? "open" : "historical"} orders yet.</div>`;
            return;
        }

        const header = document.createElement("div");
        header.className = "orders-header";
        header.innerHTML = `
            <span>Side</span>
            <span>Pair</span>
            <span>Type</span>
            <span>Price</span>
            <span>Amount / Total</span>
        `;
        ordersContainer.appendChild(header);

        source.slice().slice().reverse().forEach(o => {
            const row = document.createElement("div");
            row.className = "orders-row";

            const tagClass = o.side === "BUY" ? "buy" : "sell";
            const priceText = o.type === "MARKET" ? "Market" : `$${formatNumber(o.price, 2)}`;
            const statusExtra = o.status && o.status !== "OPEN" ? ` (${o.status})` : "";

            row.innerHTML = `
                <span><span class="tag ${tagClass}">${o.side}</span></span>
                <span>${o.symbol}/USDT</span>
                <span>${o.type}</span>
                <span>${priceText}</span>
                <span class="muted">${formatNumber(o.amount, 6)} @ ${formatNumber(o.total, 2)} USDT${statusExtra}</span>
            `;
            ordersContainer.appendChild(row);
        });
    }

    function renderSymbolSelect() {
        symbolSelect.innerHTML = "";
        coins.forEach(c => {
            const opt = document.createElement("option");
            opt.value = c.symbol;
            opt.textContent = `${c.symbol} / USDT`;
            symbolSelect.appendChild(opt);
        });
        symbolSelect.value = currentSymbol;
    }

    function updatePairInfo() {
        const coin = getCoin(currentSymbol) || coins[0];
        pairTitle.textContent = `${coin.symbol} / USDT`;
        pairPriceEl.textContent = "$" + formatNumber(coin.price, 2);
        pairChangeEl.textContent =
            (coin.change >= 0 ? "+" : "") + coin.change.toFixed(2) + "%";

        if (coin.change >= 0) {
            pairChangeEl.classList.remove("red");
        } else {
            pairChangeEl.classList.add("red");
        }

        summaryPair.textContent = `${coin.symbol} / USDT`;

        if (currentType === "MARKET") {
            priceInput.value = coin.price.toFixed(2);
        }

        updateAvailableBalance();
        recalcTotal();
    }

    function updateAvailableBalance() {
        const bal = balances[currentSymbol] || 0;
        availableBalanceEl.textContent = `${formatNumber(bal, 8)} ${currentSymbol}`;
    }

    function recalcTotal() {
        const amount = parseFloat(amountInput.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        const total = amount * price;

        if (total > 0) {
            totalInput.value = total.toFixed(2);
            summaryTotal.textContent = `${formatNumber(total, 2)} USDT`;
        } else {
            totalInput.value = "";
            summaryTotal.textContent = "0.00 USDT";
        }

        const fee = total * FEE_RATE;
        feeText.textContent = `Fee (0.1%): ${formatNumber(fee || 0, 4)} USDT`;
    }

    function setSide(side) {
        currentSide = side;
        orderSideInput.value = side;

        sideToggle.querySelectorAll("button").forEach(btn => {
            btn.classList.remove("active", "buy", "sell");
        });
        const btn = sideToggle.querySelector(`[data-side="${side}"]`);
        btn.classList.add("active");
        btn.classList.add(side === "BUY" ? "buy" : "sell");

        summarySide.textContent = side === "BUY" ? "Buy" : "Sell";
        amountHint.textContent = side === "BUY" ? "Amount you want to buy" :
            "Amount you want to sell";
        submitBtn.classList.toggle("sell", side === "SELL");
        submitLabel.textContent =
            `Place ${side === "BUY" ? "Buy" : "Sell"} ${currentType === "MARKET" ? "Market" : "Limit"} Order`;
        statusMsg.textContent = "";
        statusMsg.className = "status-msg";
    }

    function setOrderType(type) {
        currentType = type;
        orderTypeInput.value = type;

        typeToggle.querySelectorAll("button").forEach(btn => {
            btn.classList.remove("active", "type");
        });
        const btn = typeToggle.querySelector(`[data-type="${type}"]`);
        btn.classList.add("active", "type");

        summaryType.textContent = type === "MARKET" ? "Market" : "Limit";
        const coin = getCoin(currentSymbol);

        if (type === "MARKET") {
            priceInput.value = coin.price.toFixed(2);
            priceInput.readOnly = true;
            priceInfo.textContent = "Market price";
        } else {
            priceInput.readOnly = false;
            priceInfo.textContent = "Your limit price";
        }

        submitLabel.textContent =
            `Place ${currentSide === "BUY" ? "Buy" : "Sell"} ${currentType === "MARKET" ? "Market" : "Limit"} Order`;

        recalcTotal();
    }

    function showStatus(message, isError = false) {
        statusMsg.textContent = message;
        statusMsg.className = "status-msg " + (isError ? "status-error" : "status-success");
    }

    // ===== EVENTS =====

    tabs.forEach(tab => {
        tab.addEventListener("click", () => {
            tabs.forEach(t => t.classList.remove("active"));
            tab.classList.add("active");
            currentTab = tab.dataset.tab;
            renderMarkets();
        });
    });

    searchInput.addEventListener("input", () => {
        renderMarkets();
    });

    marketsListEl.addEventListener("click", (e) => {
        const pill = e.target.closest(".pill");
        const iconBtn = e.target.closest(".icon-btn");

        if (pill) {
            const sym = pill.dataset.symbol;
            const action = pill.dataset.action;
            currentSymbol = sym;
            renderSymbolSelect();
            updatePairInfo();
            renderOrderBook();
            renderTrades();
            setSide(action.toUpperCase());
        }

        if (iconBtn) {
            const sym = iconBtn.dataset.symbol;
            const type = iconBtn.dataset.icon;
            if (type === "fav") {
                if (favourites.has(sym)) favourites.delete(sym);
                else favourites.add(sym);
            } else if (type === "watch") {
                if (watchlist.has(sym)) watchlist.delete(sym);
                else watchlist.add(sym);
            }
            renderMarkets();
        }
    });

    sideToggle.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;
        const side = btn.dataset.side;
        if (!side) return;
        setSide(side);
    });

    typeToggle.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;
        const type = btn.dataset.type;
        if (!type) return;
        setOrderType(type);
    });

    symbolSelect.addEventListener("change", () => {
        currentSymbol = symbolSelect.value;
        updatePairInfo();
        renderOrderBook();
        renderTrades();
    });

    amountInput.addEventListener("input", recalcTotal);
    priceInput.addEventListener("input", recalcTotal);

    ordersTabsButtons.forEach(btn => {
        btn.addEventListener("click", () => {
            ordersTabsButtons.forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            currentOrdersTab = btn.dataset.ordersTab;
            renderOrders();
        });
    });

    orderForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const amount = parseFloat(amountInput.value);
        const price = parseFloat(priceInput.value);
        const coin = getCoin(currentSymbol);
        if (!coin) return;

        if (!amount || amount <= 0 || !price || price <= 0) {
            showStatus("Enter a valid amount and price.", true);
            return;
        }

        const total = amount * price;
        const fee = total * FEE_RATE;
        const totalWithFee = total + fee;

        if (currentSide === "BUY") {
            if (balances.USDT < totalWithFee && currentType === "MARKET") {
                showStatus("Not enough USDT to buy (including fee).", true);
                return;
            }
            if (currentType === "MARKET") {
                // Market order executes immediately at mid price
                balances.USDT -= totalWithFee;
                balances[currentSymbol] = (balances[currentSymbol] || 0) + amount;
                const order = {
                    id: nextOrderId++,
                    symbol: currentSymbol,
                    side: "BUY",
                    type: "MARKET",
                    price,
                    amount,
                    total: totalWithFee,
                    status: "FILLED"
                };
                orderHistory.push(order);
                showStatus("Market buy executed (demo only).");
            } else {
                // Limit buy: if limit >= best ask -> fill now; else open order
                const bestAsk = coin.orderBook.asks.length ? coin.orderBook.asks[0].price : coin.price;
                if (price >= bestAsk) {
                    if (balances.USDT < totalWithFee) {
                        showStatus("Not enough USDT to buy (including fee).", true);
                        return;
                    }
                    balances.USDT -= totalWithFee;
                    balances[currentSymbol] = (balances[currentSymbol] || 0) + amount;
                    orderHistory.push({
                        id: nextOrderId++,
                        symbol: currentSymbol,
                        side: "BUY",
                        type: "LIMIT",
                        price,
                        amount,
                        total: totalWithFee,
                        status: "FILLED"
                    });
                    showStatus("Limit buy immediately filled (price crossed).");
                } else {
                    openOrders.push({
                        id: nextOrderId++,
                        symbol: currentSymbol,
                        side: "BUY",
                        type: "LIMIT",
                        price,
                        amount,
                        total: totalWithFee,
                        status: "OPEN"
                    });
                    showStatus("Limit buy placed (open order).");
                }
            }
        } else {
            // SELL
            if ((balances[currentSymbol] || 0) < amount && currentType === "MARKET") {
                showStatus(`Not enough ${currentSymbol} to sell.`, true);
                return;
            }
            if (currentType === "MARKET") {
                balances[currentSymbol] -= amount;
                balances.USDT += total - fee; // fee taken from proceeds
                orderHistory.push({
                    id: nextOrderId++,
                    symbol: currentSymbol,
                    side: "SELL",
                    type: "MARKET",
                    price,
                    amount,
                    total: total - fee,
                    status: "FILLED"
                });
                showStatus("Market sell executed (demo only).");
            } else {
                const bestBid = coin.orderBook.bids.length ? coin.orderBook.bids[0].price : coin.price;
                if (price <= bestBid) {
                    if ((balances[currentSymbol] || 0) < amount) {
                        showStatus(`Not enough ${currentSymbol} to sell.`, true);
                        return;
                    }
                    balances[currentSymbol] -= amount;
                    balances.USDT += total - fee;
                    orderHistory.push({
                        id: nextOrderId++,
                        symbol: currentSymbol,
                        side: "SELL",
                        type: "LIMIT",
                        price,
                        amount,
                        total: total - fee,
                        status: "FILLED"
                    });
                    showStatus("Limit sell immediately filled (price crossed).");
                } else {
                    openOrders.push({
                        id: nextOrderId++,
                        symbol: currentSymbol,
                        side: "SELL",
                        type: "LIMIT",
                        price,
                        amount,
                        total: total - fee,
                        status: "OPEN"
                    });
                    showStatus("Limit sell placed (open order).");
                }
            }
        }

        amountInput.value = "";
        recalcTotal();
        renderWallet();
        renderOrders();
    });

    // ===== ORDER BOOK & TRADES SIMULATION =====

    function generateOrderBook(price) {
        const bids = [];
        const asks = [];
        const levels = 10;
        const step = price * 0.0015; // 0.15%

        for (let i = levels; i >= 1; i--) {
            const p = price - step * i;
            bids.push({
                price: Math.max(0.0001, p),
                size: Math.random() * 0.7 + 0.01
            });
        }
        for (let i = 1; i <= levels; i++) {
            const p = price + step * i;
            asks.push({
                price: Math.max(0.0001, p),
                size: Math.random() * 0.7 + 0.01
            });
        }
        return {bids: bids.sort((a, b) => b.price - a.price), asks};
    }

    function addRandomTrade(coin) {
        const side = Math.random() > 0.5 ? "BUY" : "SELL";
        const price = coin.price * (1 + (Math.random() - 0.5) * 0.002);
        const amount = Math.random() * 0.6 + 0.01;
        coin.trades.push({side, price, amount});
        if (coin.trades.length > 40) coin.trades.shift();
    }

    function simulateTick() {
        coins.forEach(c => {
            const drift = 1 + (Math.random() - 0.5) * 0.0035; // ±0.175%
            c.price = Math.max(0.0001, c.price * drift);
            c.change += (Math.random() - 0.5) * 0.15;
            c.orderBook = generateOrderBook(c.price);
            addRandomTrade(c);
        });

        matchOpenOrders();
        renderMarkets();
        updatePairInfo();
        renderOrderBook();
        renderTrades();
        renderOrders();
    }

    function matchOpenOrders() {
        for (let i = openOrders.length - 1; i >= 0; i--) {
            const o = openOrders[i];
            const coin = getCoin(o.symbol);
            if (!coin) continue;
            const bestAsk = coin.orderBook.asks.length ? coin.orderBook.asks[0].price : coin.price;
            const bestBid = coin.orderBook.bids.length ? coin.orderBook.bids[0].price : coin.price;

            let shouldFill = false;
            let fillPrice = coin.price;

            if (o.side === "BUY" && bestAsk <= o.price) {
                shouldFill = true;
                fillPrice = bestAsk;
            } else if (o.side === "SELL" && bestBid >= o.price) {
                shouldFill = true;
                fillPrice = bestBid;
            }

            if (shouldFill) {
                const total = o.amount * fillPrice;
                const fee = total * FEE_RATE;

                if (o.side === "BUY") {
                    if (balances.USDT >= total + fee) {
                        balances.USDT -= total + fee;
                        balances[o.symbol] = (balances[o.symbol] || 0) + o.amount;
                    }
                } else {
                    if ((balances[o.symbol] || 0) >= o.amount) {
                        balances[o.symbol] -= o.amount;
                        balances.USDT += total - fee;
                    }
                }

                orderHistory.push({
                    ...o,
                    price: fillPrice,
                    total: o.side === "BUY" ? total + fee : total - fee,
                    status: "FILLED"
                });
                openOrders.splice(i, 1);
            }
        }
        renderWallet();
    }

    // ===== INIT =====

    (function init() {
        // prepare books & trades
        coins.forEach(c => {
            c.orderBook = generateOrderBook(c.price);
            for (let i = 0; i < 8; i++) addRandomTrade(c);
        });

        renderSymbolSelect();
        renderMarkets();
        renderOrderBook();
        renderTrades();
        renderWallet();
        renderOrders();
        updatePairInfo();
        setSide("BUY");
        setOrderType("MARKET");

        setInterval(simulateTick, 6000);
    })();
</script>

</body>
</html>
